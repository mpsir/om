var W=window||{},zim=function(e){return W.b2Vec2=Box2D.Common.Math.b2Vec2,W.b2BodyDef=Box2D.Dynamics.b2BodyDef,W.b2Body=Box2D.Dynamics.b2Body,W.b2FixtureDef=Box2D.Dynamics.b2FixtureDef,W.b2Fixture=Box2D.Dynamics.b2Fixture,W.b2World=Box2D.Dynamics.b2World,W.b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,W.b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,W.b2MouseJointDef=Box2D.Dynamics.Joints.b2MouseJointDef,W.b2DistanceJointDef=Box2D.Dynamics.Joints.b2DistanceJointDef,W.b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef,W.b2WeldJointDef=Box2D.Dynamics.Joints.b2WeldJointDef,W.b2AABB=Box2D.Collision.b2AABB,W.b2DebugDraw=Box2D.Dynamics.b2DebugDraw,W.b2BuoyancyController=Box2D.Dynamics.Controllers.b2BuoyancyController,W.b2ContactListener=Box2D.Dynamics.b2ContactListener,W.zimPhysics=!0,e.Physics=function(t,o,r,i){var n;if(n=zob(e.Physics,arguments,"gravity, borders, scroll, frame",this))return n;var a=this;if(e.zon&&zog("ZIM PHYSICS"),zot(i))if(W.zdf)i=W.zdf;else{if(!W.zimDefaultFrame)return void console.log("zim.Physics() - please provide a zim Frame object");i=W.zimDefaultFrame}a.frame=i,zot(o)&&(o={x:0,y:0,width:a.frame.width,height:a.frame.height}),o={x:o.x,y:o.y,width:o.width,height:o.height},zot(t)&&(t=10),zot(r)&&(r=!1),this.scroll=r,zot(W.zimDefaultPhysics)&&(W.zimDefaultPhysics=this);var s=a.frame.stage;zot(e.scaX)&&(createjs.stageTransformable=!1,e.scaX=s.scaleX,e.scaY=s.scaleY);var l=this.scale=30,c=this.step=20;this.timeStep=1/c;var d,f=!1,h=this.world=new b2World(new b2Vec2(0,t),!0);function b(t,o,r,i,n,s,c,d,f){var b=t[0];zot(o)&&(o=!0),zot(r)&&(r=.8),zot(i)&&(i=.5),zot(f)&&(f=.5),zot(n)&&(n=1),zot(s)&&(s=0);var u=new b2BodyDef;u.type="kinematic"==o?b2Body.b2_kinematicBody:o?b2Body.b2_dynamicBody:b2Body.b2_staticBody,u.angularDamping=i,u.linearDamping=f;var m,g=h.CreateBody(u);if("rectangle"==b)m=new b2PolygonShape,zot(t[1])&&(t[1]=100),zot(t[2])&&(t[2]=100),m.width=t[1],m.height=t[2],m.SetAsBox(m.width/l/2,m.height/l/2);else if("triangle"==b){if(!e)return;m=new b2PolygonShape,zot(t[1])&&(t[1]=100),zot(t[2])&&(t[2]=100),zot(t[3])&&(t[3]=100);var y=new e.Triangle(t[1],t[2],t[3]);m.width=y.width,m.height=y.height;var w=[];w[2]=new b2Vec2((y.one.x-y.regX)/l,(y.one.y+y.regY)/l),w[1]=new b2Vec2((y.two.x-y.regX)/l,(y.two.y+y.regY)/l),w[0]=new b2Vec2((y.three.x-y.regX)/l,(y.three.y+y.regY)/l),m.SetAsArray(w,w.length)}else zot(t[1])&&(t[1]=50),(m=new b2CircleShape(t[1]/l)).width=m.height=2*t[1];var v=new b2FixtureDef;return zot(d)||(v.filter.categoryBits=d),zot(c)||(v.filter.maskBits=c),v.shape=m,v.density=n,v.friction=r,v.restitution=s,g.CreateFixture(v),g.width=m.width,g.height=m.height,g.zimX=0,g.zimY=0,g.zimR=0,function(e){Object.defineProperty(e,"x",{get:function(){return e.GetWorldCenter().x*a.scale},set:function(t){e.zimX=t,e.SetPosition(new b2Vec2(e.zimX/l,e.zimY/l))}}),Object.defineProperty(e,"y",{get:function(){return e.GetWorldCenter().y*a.scale},set:function(t){e.zimY=t,e.SetPosition(new b2Vec2(e.zimX/l,e.zimY/l))}}),Object.defineProperty(e,"rotation",{get:function(){return 180*e.GetAngle()/Math.PI},set:function(t){e.zimR=t,e.SetAngle(t*Math.PI/180)}})}(g),g}this.makeRectangle=function(e,t,o,r,i,n,s,l,c,d){var f;return(f=zob(a.makeRectangle,arguments))?f:b(["rectangle",e,t],o,r,i,n,s,l,c,d)},this.makeCircle=function(e,t,o,r,i,n,s,l,c){var d;return(d=zob(a.makeCircle,arguments))?d:b(["circle",e],t,o,r,i,n,s,l,c)},this.makeTriangle=function(e,t,o,r,i,n,s,l,c,d,f){var h;return(h=zob(a.makeTriangle,arguments))?h:b(["triangle",e,t,o],r,i,n,s,l,c,d,f)},Object.defineProperty(this,"gravity",{get:function(){return this.world.GetGravity()},set:function(e){this.world.SetGravity(new b2Vec2(0,e))}}),this.join=function(t,o,r,i,n,s,l){var c,d;return(c=zob(a.join,arguments))?c:zot(t)||zot(o)?void 0:(t.body&&(t=t.body),o.body&&(o=o.body),zot(r)&&(r=new e.Point(t.GetWorldCenter().x*a.scale,t.GetWorldCenter().y*a.scale)),zot(i)&&(i=new e.Point(o.GetWorldCenter().x*a.scale,o.GetWorldCenter().y*a.scale)),zot(l)&&(l="weld"),"distance"==l&&(d=new b2DistanceJointDef),"revolute"==l&&(d=new b2RevoluteJointDef),"weld"==l&&(d=new b2WeldJointDef),d.Initialize(t,o,new b2Vec2(r.x/a.scale,r.y/a.scale),new b2Vec2(i.x/a.scale,i.y/a.scale)),zot(n)&&zot(s)||(d.enableLimit=!0,d.lowerAngle=n*Math.PI/180,d.upperAngle=s*Math.PI/180),a.world.CreateJoint(d))},this.break=function(e){a.world.DestroyJoint(e)},this.makeJoint=function(e,t,o,r,i,n,s){var l=zot(s)||"distance"!=s?new b2RevoluteJointDef:new b2DistanceJointDef;return l.Initialize(e,t,e.GetWorldPoint(new b2Vec2(o/a.scale,r/a.scale))),zot(i)&&zot(n)||(l.enableLimit=!0,l.lowerAngle=i*Math.PI/180,l.upperAngle=n*Math.PI/180),a.world.CreateJoint(l)},this.debug=function(){return d?d.debugCanvas.style.display="block":d=new this.Debug,d.active=!0,a.updateDebug(),a},this.Debug=function(){var e=this.debugCanvas=document.createElement("canvas");if(e.setAttribute("id","debugCanvas"),1!=a.frame.scale)e.setAttribute("width",a.frame.width),e.setAttribute("height",a.frame.height);else{var t=Math.max(W.innerWidth,screen.width,W.innerHeight,screen.height);e.setAttribute("width",t),e.setAttribute("height",t)}a.frame.canvas.parentElement.appendChild(e),e.style.pointerEvents="none";var o=new b2DebugDraw;o.SetSprite(e.getContext("2d")),o.SetDrawScale(l),o.SetFillAlpha(.7),o.SetLineThickness(1),o.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),h.SetDebugDraw(o),this.update=function(){h.m_debugDraw.m_sprite.graphics.clear(),h.DrawDebugData()}},this.updateDebug=function(){if(!zot(d)){(function(t){var o=t,r=0,i=0;for(;"object"==typeof o&&void 0!==o.tagName;)i+=o.offsetTop,r+=o.offsetLeft,"BODY"==o.tagName.toUpperCase()&&(o=0),"object"==typeof o&&"object"==typeof o.offsetParent&&(o=o.offsetParent);e.scrollX(),e.scrollY()})(a.frame.canvas);var t=d.debugCanvas;return t.style.position="absolute",t.style.zIndex=2,t.style.left=a.frame.canvas.style.left,t.style.top=a.frame.canvas.style.top,t.style.width=a.frame.canvas.style.width,t.style.height=a.frame.canvas.style.height,this}},this.removeDebug=function(){if(d)return d.active=!1,d.debugCanvas.style.display="none",this};var u,m=[];function g(){var e=m.length;if(0!=e)for(var t,o=e-1;o>=0;o--)t=m[o],y.remove(t),h.DestroyBody(t),t=null,m.pop()}this.remove=function(e){m.push(e)},this.follow=function(e,t,r,i,n,l,c,d,f,h,b,u,m){var g;if(g=zob(a.follow,arguments))return g;if(a.followObj=null,!zot(e)){e.zimObj&&(e=e.zimObj),e.controlX=e.controlDirX=e.controlY=e.controlDirY=0,a.followObj=e,e.followDampX=null,e.followDampY=null,zot(t)&&(t=.05),zot(r)&&(r=t),zot(i)&&(i=0),zot(n)&&(n=a.frame.stage.width),zot(l)&&(l=0),zot(c)&&(c=a.frame.stage.height),zot(d)&&(d=.02),zot(f)&&(f=d),zot(h)&&(h=!0),zot(b)&&(b=!0),zot(u)&&(u=o.constructor==={}.constructor),zot(m)&&(m=!1),e.frameBorderLock=u,e.frameBorderOriginal=m,h&&(e.followDampX=new Damp(0,t),e.offsetDampX=new Damp((i+n)/2,d),e.followOffsetX=[(i+n)/2,i,n]),b&&(e.followDampY=new Damp(0,r),e.offsetDampY=new Damp((l+c)/2,f),e.followOffsetY=[(l+c)/2,l,c]),a.followSpeed=0;var y=s.x,w=Date.now();e.followTicker=a.Ticker.add(function(){var e=Date.now(),t=e-w;if(0!=t){var o=y-s.x;a.followSpeed=o/t*1e3,w=e,y=s.x}})}},this.control=function(e,t,o,r,i,n){var s;if(e.ground=!0,s=zob(a.control,arguments))return s;if(!zot(e)){e.zimObj&&(zimObj=e.zimObj),a.controlObj=e,e.controlX=0,e.controlY=0,zot(t)&&(t="both"),zot(o)&&(o=200),zot(r)&&(r=o),zot(i)&&(i=!0),zot(n)&&(n=!0);var l=[0,0,0,0,0,0,0,0,0,0,0,0];e.controlKeydown=a.frame.on("keydown",function(t){e.ground&&d(t.keyCode,o,r)}),e.controlKeyup=a.frame.on("keyup",function(e){d(e.keyCode,0,0)}),a.customControl=function(e,t,i){d(e,zot(t)?o:t,zot(i)?r:i),zog(e,o)};var c=e.body;e.controlTicker=a.Ticker.add(function(){Math.abs(l[0]+l[2]+l[4]+l[6]+l[8]+l[10])+Math.abs(l[1]+l[3]+l[5]+l[7]+l[9]+l[11])!=0&&c.ApplyForce(new b2Vec2(l[0]+l[2]+l[4]+l[6]+l[8]+l[10]>0?o:l[0]+l[2]+l[4]+l[6]+l[8]+l[10]<0?-o:0,l[1]+l[3]+l[5]+l[7]+l[9]+l[11]>0?r:l[1]+l[3]+l[5]+l[7]+l[9]+l[11]<0?-r:0),c.GetWorldCenter())})}function d(o,r,a){37!=o||!i||"both"!=t&&"arrows"!=t||(l[0]=-r),38!=o||!n||"both"!=t&&"arrows"!=t||(l[1]=-a),39!=o||!i||"both"!=t&&"arrows"!=t||(l[2]=r),40!=o||!n||"both"!=t&&"arrows"!=t||(l[3]=a),65!=o||!i||"both"!=t&&"wasd"!=t||(l[4]=-r),87!=o||!n||"both"!=t&&"wasd"!=t||(l[5]=-a),68!=o||!i||"both"!=t&&"wasd"!=t||(l[6]=r),83!=o||!n||"both"!=t&&"wasd"!=t||(l[7]=a),"left"==o&&i&&(l[8]=-r),"up"==o&&n&&(l[9]=-r),"right"==o&&i&&(l[10]=r),"down"==o&&n&&(l[11]=r),e.controlDirX=l[0]+l[2]+l[4]+l[6]+l[8]+l[10]==0?0:l[0]+l[2]+l[4]+l[6]+l[8]+l[10]>0?1:-1,e.controlDirY=l[1]+l[3]+l[5]+l[7]+l[9]+l[11]==0?0:l[1]+l[3]+l[5]+l[7]+l[9]+l[11]>0?1:-1,e.controlX=l[0]+l[2]+l[4]+l[6]+l[8]+l[10]==0?0:l[0]+l[2]+l[4]+l[6]+l[8]+l[10]>0?1:2,e.controlY=l[1]+l[3]+l[5]+l[7]+l[9]+l[11]==0?0:l[1]+l[3]+l[5]+l[7]+l[9]+l[11]>0?1:2}},this.noControl=function(e){!zot(e)&&e.controlTicker&&(a.controlObj=null,a.Ticker.remove(e.controlTicker),a.frame.off("keydown",e.controlKeydown),a.frame.off("keyup",e.controlKeyup),e.controlX=e.controlDirX=e.controlY=e.controlDirY=0)},this.dragList=[],this.noDragList=[],this.drag=function(e){zot(e)&&(e=[]),Array.isArray(e)||(e=[e]),0==e.length&&(a.noDragList=[]);for(var t=0;t<e.length;t++){e[t].body&&(e[t]=e[t].body);var o=this.noDragList.indexOf(e[t]);o>=0&&this.noDragList.splice(o,1)}return u?this.dragList=this.dragList.concat(e):u=new a.Drag(e),this},this.noDrag=function(e){if(!this.dragList)return this;if(zot(e))u.removeListeners(),u=null;else{Array.isArray(e)||(e=[e]);for(var t=a.dragList.length,o=0;o<e.length;o++){e[o].body&&(e[o]=e[o].body);var r=a.dragList.indexOf(e[o]);r>=0?a.dragList.splice(r,1):a.noDragList.push(e[o])}0==a.dragList.length&&t>0&&(u.removeListeners(),u=null)}},this.Drag=function(t){if(zot(i)&&(i={scale:1}),void 0===a){for(var o=0;o<t.length;o++)t[o].body&&(t[o]=t[o].body);a=this}var r=this;this.removeListeners=function(){f=!1,r.mousedownEvent&&u.off("stagemousedown",r.mousedownEvent),r.mousemoveEvent&&u.off("stagemousemove",r.mousemoveEvent),r.mouseupEvent&&u.off("stagemouseup",r.mouseupEvent),b&&h.DestroyJoint(b),b=null,a.dragList=null},this.removeListeners(),a.dragList=t;var n,s,c,d,b,u=a.frame.stage;function m(e){return e.GetBody().GetType()==b2Body.b2_staticBody||!e.GetShape().TestPoint(e.GetBody().GetTransform(),c)||(d=e.GetBody(),!1)}r.mousedownEvent=u.on("stagemousedown",function(t){f=!0,n=t.stageX/e.scaX/l,s=t.stageY/e.scaY/l,r.mousemoveEvent=u.on("stagemousemove",function(t){n=t.stageX/e.scaX/l,s=t.stageY/e.scaY/l})}),r.mouseupEvent=u.on("stagemouseup",function(t){f=!1,u.off("stagemousemove",r.mousemoveEvent),n=t.stageX/e.scaX/l,s=t.stageY/e.scaY/l}),this.update=function(){if(f&&!b){var e=function(){c=new b2Vec2(n,s);var e=new b2AABB;return e.lowerBound.Set(n-.001,s-.001),e.upperBound.Set(n+.001,s+.001),d=null,h.QueryAABB(m,e),d}();if(e){if(a.noDragList.indexOf(e)>=0||a.dragList.length>0&&a.dragList.indexOf(e)<0)return;var t=new b2MouseJointDef;t.bodyA=h.GetGroundBody(),t.bodyB=e,t.target.Set(n,s),t.collideConnected=!0,t.maxForce=300*e.GetMass(),b=h.CreateJoint(t),e.SetAwake(!0)}}b&&(f?b.SetTarget(new b2Vec2(n,s)):(h.DestroyJoint(b),b=null))}};var y=new e.Dictionary(!0);this.addMap=function(e,t){zot(e)||zot(t)?console.log("physics.Map() - please provide a box2DBody and zimObj"):(t.body=e,e.zimObj=t,y.add(e,t))},this.removeMap=function(e){y.remove(e)},this.borders=function(e){if(!(zot(e.x)||zot(e.y)||zot(e.width)||zot(e.height))){a.borderTop&&a.remove(a.borderTop),a.borderBottom&&a.remove(a.borderBottom),a.borderLeft&&a.remove(a.borderLeft),a.borderRight&&a.remove(a.borderRight);var t=2e3;new b2PolygonShape,new b2BodyDef;a.borderLeft=a.makeRectangle(4e3,e.height,!1),a.borderLeft.x=e.x-t,a.borderLeft.y=e.y+e.height/2,a.borderLeft.zimObj={type:"Border",side:"left"},a.borderRight=a.makeRectangle(4e3,e.height,!1),a.borderRight.x=e.x+e.width+t,a.borderRight.y=e.y+e.height/2,a.borderRight.zimObj={type:"Border",side:"right"},a.borderTop=a.makeRectangle(e.width,4e3,!1),a.borderTop.x=e.x+e.width/2,a.borderTop.y=e.y-t,a.borderTop.zimObj={type:"Border",side:"top"},a.borderBottom=a.makeRectangle(e.width,4e3,!1),a.borderBottom.x=e.x+e.width/2,a.borderBottom.y=e.y+e.height+t,a.borderBottom.zimObj={type:"Border",side:"bottom"},a._borders=e}},this.borders(o),this.paused=!1,this.pause=function(e){zot(e)&&(e=!0),this.timeStep=e?0:1/this.step,this.paused=e};var w,v=new e.Dictionary,D=new e.Dictionary;this.Ticker={add:function(e,t){return zot(t)&&(t=!0),t?D.add(e,1):v.add(e,1),e},remove:function(e){D.remove(e),v.remove(e)}},function t(){w=requestAnimationFrame(t),u&&u.update();for(var o=0;o<v.objects.length;o++)v.objects[o]();for(h.Step(a.timeStep,10,10),g(),h.ClearForces(),o=0;o<D.objects.length;o++)D.objects[o]();d&&d.active&&d.update(),function(){for(var t=0;t<y.length;t++){var o=y.values[t],r=y.objects[t],n=r.GetWorldPoint(new b2Vec2(0,0));if(a.scroll){o.x=n.x*l,o.y=n.y*l;var s=a.frame.stage;if(!f){var c=(i.retina?i.scale:1)*e.scaX,d=(i.retina?i.scale:1)*e.scaY;a.followObj&&a.followObj==o&&o.followDampX&&(s.x=c*o.followDampX.convert(o.offsetDampX.convert(o.followOffsetX[o.controlX])-o.x)),a.followObj&&a.followObj==o&&o.followDampY&&(s.y=d*o.followDampY.convert(o.offsetDampY.convert(o.followOffsetY[o.controlY])-o.y)),o.frameBorderLock&&(s.x<c*(s.width-a._borders.x-a._borders.width)&&(o.frameBorderOriginal&&0==a.borderRight.m_fixtureCount||1==a.borderRight.m_fixtureCount)&&(s.x=c*(s.width-a._borders.x-a._borders.width)),s.y<d*(s.height-a._borders.y-a._borders.height)&&(o.frameBorderOriginal&&0==a.borderBottom.m_fixtureCount||1==a.borderBottom.m_fixtureCount)&&(s.y=d*(s.height-a._borders.y-a._borders.height)),s.x>-c*a._borders.x&&(o.frameBorderOriginal&&0==a.borderLeft.m_fixtureCount||1==a.borderLeft.m_fixtureCount)&&(s.x=-c*a._borders.x),s.y>-d*a._borders.y&&(o.frameBorderOriginal&&0==a.borderTop.m_fixtureCount||1==a.borderTop.m_fixtureCount)&&(s.y=-d*a._borders.y))}}else{var h=o.parent.globalToLocal(n.x*l,n.y*l);o.x=h.x,o.y=h.y}o.rotation=r.GetAngle()*(180/Math.PI)}a.frame.stage.update()}()}(),this.dispose=function(){u&&u.removeListeners(),this==W.zimDefaultPhysics&&(W.zimDefaultPhysics=null),W.zimContactListener=null;for(var e=0;e<y.length;e++){y.values[e].removePhysics()}g();for(var t=a.world.GetBodyList();t;){var o=t;t=t.GetNext(),a.world.DestroyBody(o),o=null}a.removeDebug(),cancelAnimationFrame(w),a.world=null}},e}(zim||{});W.zns||(W.Physics=zim.Physics);